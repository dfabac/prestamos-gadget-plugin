<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs
			title="Préstamos"
			author="rtve.es"
			author_email="dfabac@gmail.com"
			description="Préstamos JIRA Gadget"
			screenshot='#staticResourceUrl("com.rtve.pluginsjira.prestamos-gadget-plugin:prestamos-gadget-plugin-resources", "gadget-screenshot.png")'
			thumbnail='#staticResourceUrl("com.rtve.pluginsjira.prestamos-gadget-plugin:prestamos-gadget-plugin-resources", "gadget-thumb.png")'>
		<Optional feature="gadget-directory">
			<Param name="categories">
                Other
			</Param>
		</Optional>
		<Require feature="dynamic-height" />
		<Require feature="tabs" />
		<Require feature="settitle" />
		<Require feature="minimessage" />
		<Optional feature="auth-refresh" />
	</ModulePrefs>

	<Content type="html" view="default"><![CDATA[

		#requireResource("com.atlassian.jira.gadgets:common")
		#includeResources()
		<style TYPE="text/css">
			.tablib_content_container { 
				max-height: 150px;
				overflow: -moz-scrollbars-vertical; 
				overflow-y:scroll; 
			}
		</style>

		<script type="text/javascript">

			//var msg = new gadgets.MiniMessage(__MODULE_ID__);
			//msg.createDismissibleMessage("Please close me when you're done reading me.");

			var PROJECT_KEY = 'TEST';

			var tabs = new gadgets.TabSet(__MODULE_ID__);

			function makeTab(tabId) {
				url = "__ATLASSIAN_BASE_URL__/rest/api/latest/search?jql=";
				url = url + escape("project = " + PROJECT_KEY);

				if(tabs.getSelectedTab().getIndex() == 0) {
					// reservas de usuario
					url = url + escape(" AND assignee in (currentUser())");
				} else {
					// material disponible
					var issuetype = asset_types[tabId].id;
					url = url + escape(" AND assignee is EMPTY AND issuetype =" + issuetype);
				}

				var params = {};
				params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
				params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;

				gadgets.io.makeRequest(url, function (response) {
					var issues = response.data.issues;

  					var main    = document.createElement("div");
					var tbl     = document.createElement("table");
					var tblBody = document.createElement("tbody");

  					for(var issue in issues) {
  						tblBody.appendChild(makeRow(issues[issue]));
  					}
					
					tbl.className = "issue-table";
  					tbl.appendChild(tblBody);
  					main.appendChild(tbl);
 
					var item = document.getElementById(tabId);
					if (item.childNodes[0]) {
						item.replaceChild(main, item.childNodes[0]);
					} else {
						item.appendChild(main);
					}

					gadgets.window.adjustHeight();
				}, params);
			}

			function makeRow(issue){
				var row = document.createElement("tr");
				row.className = "issuerow";

				var a = document.createElement('a');
				a.appendChild(document.createTextNode(issue.key));
				a.href = "__ATLASSIAN_BASE_URL__/browse/" + issue.key;
				a.target="_parent";

				var cellKey = document.createElement("td");
				cellKey.className = "issue-link";
				cellKey.appendChild(a);
				
				var cellItem = document.createElement("td");
				cellItem.appendChild(document.createTextNode(issue.fields.summary));

				var cellButton = document.createElement("td");
				var button = document.createElement("input");
				button.type = "button";
				button.value = "Reservar";
				cellButton.appendChild(button);

				row.appendChild(cellKey);
				row.appendChild(cellItem);
				row.appendChild(cellButton);

				return row;
			}

			var asset_types = {};

			function init() {
				url = "__ATLASSIAN_BASE_URL__/rest/api/latest/project/TEST";
				var params = {};
				params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
				params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;

				gadgets.io.makeRequest(url, function (response,res) {
					var issuetypes = response.data.issueTypes;

					// pestaña de reservas del usuario
					tabs.addTab('Mis reservas', {
						callback: makeTab,
						index: 0
					});

					// pestañas para resto material disponible
					for(var it in issuetypes) {
						var tab_id = tabs.addTab(issuetypes[it].name, {
							callback : makeTab,
							tooltip  : "ID: " + issuetypes[it].id
						});

						asset_types[tab_id] = {
							name : issuetypes[it].name, 
							id   : issuetypes[it].id
						};
					}
				}, params);
			}

			gadgets.util.registerOnLoadHandler(init);

		</script>

	]]></Content>
</Module>
